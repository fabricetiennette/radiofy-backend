name: Deploy (Azure Container Apps labels)

on:
  push:
    branches: ["develop", "main"]

permissions:
  contents: read
  packages: write

env:
  IMAGE_BASE: ghcr.io/${{ github.repository }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  AZURE_CONTAINERAPP_NAME: ${{ vars.AZURE_CONTAINERAPP_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Decide target (label + tag + health url)
        id: target
        shell: bash
        run: |
          if [[ "${GITHUB_REF_NAME}" == "develop" ]]; then
            echo "label=staging" >> $GITHUB_OUTPUT
            echo "tag=staging" >> $GITHUB_OUTPUT
            echo "health=${{ vars.STAGING_HEALTH_URL }}" >> $GITHUB_OUTPUT
          else
            echo "label=prod" >> $GITHUB_OUTPUT
            echo "tag=prod" >> $GITHUB_OUTPUT
            echo "health=${{ vars.PROD_HEALTH_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build & push image
        shell: bash
        run: |
          IMAGE="${IMAGE_BASE}:${{ steps.target.outputs.tag }}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Container App (label)
        shell: bash
        run: |
          az containerapp update \
            -g "$AZURE_RESOURCE_GROUP" \
            -n "$AZURE_CONTAINERAPP_NAME" \
            --image "$IMAGE" \
            --revision-suffix "${{ steps.target.outputs.label }}-${GITHUB_SHA::7}" \
            --set-labels "${{ steps.target.outputs.label }}=${AZURE_CONTAINERAPP_NAME}--${{ steps.target.outputs.label }}-${GITHUB_SHA::7}"

      - name: Smoke test – health
        shell: bash
        run: |
          URL="${{ steps.target.outputs.health }}"
          echo "Checking $URL ..."
          curl --fail --silent --show-error \
               --retry 30 --retry-delay 5 --retry-all-errors \
               --max-time 10 \
               "$URL"

      - name: Summary
        if: success()
        run: |
          echo "✅ Deployed $IMAGE to label ${{ steps.target.outputs.label }}" >> $GITHUB_STEP_SUMMARY